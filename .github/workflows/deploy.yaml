# ðŸš« DEPRECATED: Infrastructure Deployment via GitHub Actions
#
# This workflow is DISABLED in favor of pure GitOps approach.
#
# ðŸŽ¯ GitOps Flow:
# 1. CI Pipeline (ci.yaml) â†’ Build & Push image to registry
# 2. GitOps Repository â†’ ArgoCD/Flux pulls and deploys
# 3. Infrastructure managed separately via Terraform Cloud/GitOps
#
# See GITOPS-SETUP.md for complete setup instructions

name: "[DEPRECATED] Direct Infrastructure Deployment"

# ðŸ”’ This workflow is disabled - use GitOps instead
on:
  workflow_dispatch:
    inputs:
      confirm_manual_deployment:
        description: "âš ï¸ WARNING: This bypasses GitOps! Type 'CONFIRM' to proceed"
        required: true
        type: string

jobs:
  gitops-reminder:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_manual_deployment != 'CONFIRM'
    steps:
      - name: GitOps Reminder
        run: |
          echo "## âš ï¸ GitOps Deployment Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This repository follows **pure GitOps** principles:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Current GitOps Flow:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Developer** pushes to \`developer\` branch â†’ CI validation only" >> $GITHUB_STEP_SUMMARY
          echo "2. **Manager** merges PR to \`main\` â†’ Build & push image to registry" >> $GITHUB_STEP_SUMMARY
          echo "3. **ArgoCD/Flux** automatically detects new image and deploys" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Setup Instructions:" >> $GITHUB_STEP_SUMMARY
          echo "- See \`GITOPS-SETUP.md\` for complete GitOps setup" >> $GITHUB_STEP_SUMMARY
          echo "- Create GitOps repository: \`observability-gitops\`" >> $GITHUB_STEP_SUMMARY
          echo "- Install ArgoCD in your cluster" >> $GITHUB_STEP_SUMMARY
          echo "- Configure ArgoCD to monitor GitOps repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Image Registry:" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`ghcr.io/naserraoofi/observability-platform\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Tag**: \`ghcr.io/naserraoofi/observability-platform:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA Tags**: \`ghcr.io/naserraoofi/observability-platform:main-<sha>\`" >> $GITHUB_STEP_SUMMARY

          echo ""
          echo "âŒ Deployment blocked - use GitOps repository instead!"
          exit 1

  # ðŸš¨ EMERGENCY ONLY - Manual Infrastructure Deployment
  emergency-terraform-deployment:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_manual_deployment == 'CONFIRM'
    environment: emergency-deployment
    steps:
      - uses: actions/checkout@v4

      - name: Emergency Deployment Warning
        run: |
          echo "## ðŸš¨ EMERGENCY DEPLOYMENT INITIATED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **This deployment bypasses GitOps controls!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Post-Deployment Actions Required:" >> $GITHUB_STEP_SUMMARY
          echo "1. Update GitOps repository to match deployed state" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify ArgoCD shows no drift" >> $GITHUB_STEP_SUMMARY
          echo "3. Document emergency deployment in incident report" >> $GITHUB_STEP_SUMMARY
          echo "4. Review and fix root cause that required manual deployment" >> $GITHUB_STEP_SUMMARY

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Emergency Terraform Apply
        run: |
          cd terraform/envs/dev
          terraform init
          terraform plan
          terraform apply -auto-approve

          echo "ðŸš¨ Emergency deployment completed - update GitOps repository immediately!"
