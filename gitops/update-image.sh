#!/bin/bash
set -euo pipefail

# GitOps Image Update Script
# Updates container image tags in GitOps configurations

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GITOPS_DIR="${SCRIPT_DIR}"

# Input parameters
IMAGE_TAG="${1:-latest}"
ENVIRONMENT="${2:-dev}"
IMAGE_DIGEST="${3:-}"
SOURCE_COMMIT="${4:-}"

echo "ðŸš€ GitOps Image Update"
echo "====================="
echo "Environment: ${ENVIRONMENT}"
echo "Image Tag: ${IMAGE_TAG}"
echo "Image Digest: ${IMAGE_DIGEST}"
echo "Source Commit: ${SOURCE_COMMIT}"

# Function to update image tag in Kustomization files
update_kustomization() {
    local env_path="$1"
    local new_tag="$2"

    if [[ -f "${env_path}/kustomization.yaml" ]]; then
        echo "ðŸ“ Updating kustomization.yaml in ${env_path}"

        # Update image tag using yq if available, otherwise use sed
        if command -v yq >/dev/null 2>&1; then
            yq eval ".images[0].newTag = \"${new_tag}\"" -i "${env_path}/kustomization.yaml"
        else
            # Fallback to sed for basic tag replacement
            sed -i "s/newTag: .*/newTag: ${new_tag}/" "${env_path}/kustomization.yaml"
        fi

        echo "âœ… Updated image tag to: ${new_tag}"
    else
        echo "âš ï¸ No kustomization.yaml found in ${env_path}"
    fi
}

# Function to create or update image tracking file
update_image_tracking() {
    local env_dir="$1"
    local image_info="$2"

    mkdir -p "${env_dir}"

    cat > "${env_dir}/image-info.yaml" << EOF
# Auto-generated by GitOps CI pipeline
# Last updated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

apiVersion: v1
kind: ConfigMap
metadata:
  name: image-tracking
  namespace: observability-${ENVIRONMENT}
data:
  image-tag: "${IMAGE_TAG}"
  image-digest: "${IMAGE_DIGEST}"
  source-commit: "${SOURCE_COMMIT}"
  updated-at: "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
  updated-by: "ci-pipeline"
  environment: "${ENVIRONMENT}"
EOF

    echo "ðŸ“‹ Created image tracking info"
}

# Main update logic based on environment and branch
case "${ENVIRONMENT}" in
    "dev")
        echo "ðŸ§ª Updating development environment"
        ENV_PATH="${GITOPS_DIR}/environments/dev"
        K8S_PATH="../k8s/overlays/dev"

        # Development gets latest tags from developer branch
        if [[ "${IMAGE_TAG}" == "latest" || "${IMAGE_TAG}" =~ ^sha-.* ]]; then
            update_kustomization "${K8S_PATH}" "${IMAGE_TAG}"
            update_image_tracking "${ENV_PATH}" "${IMAGE_TAG}"
        else
            echo "â„¹ï¸ Non-latest tag ${IMAGE_TAG} not applied to dev environment"
        fi
        ;;

    "staging")
        echo "ðŸ—ï¸ Updating staging environment"
        ENV_PATH="${GITOPS_DIR}/environments/staging"
        K8S_PATH="../k8s/overlays/staging"

        # Staging gets semantic version tags only
        if [[ "${IMAGE_TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            update_kustomization "${K8S_PATH}" "${IMAGE_TAG}"
            update_image_tracking "${ENV_PATH}" "${IMAGE_TAG}"

            echo "ðŸ“¢ Staging update requires manual ArgoCD sync"
        else
            echo "â„¹ï¸ Non-semantic version tag ${IMAGE_TAG} not applied to staging"
        fi
        ;;

    "prod")
        echo "ðŸš€ Production environment update"
        ENV_PATH="${GITOPS_DIR}/environments/prod"
        K8S_PATH="../k8s/overlays/prod"

        # Production only gets stable semantic versions (manual process)
        echo "âš ï¸ Production updates require manual approval process"
        echo "ðŸ“‹ Candidate image: ${IMAGE_TAG}"
        echo "ðŸ“‹ Use 'promote-to-production.sh ${IMAGE_TAG}' after approval"

        # Create promotion candidate file
        update_image_tracking "${ENV_PATH}" "${IMAGE_TAG}"
        ;;

    *)
        echo "âŒ Unknown environment: ${ENVIRONMENT}"
        echo "Valid environments: dev, staging, prod"
        exit 1
        ;;
esac

# Create commit if there are changes
if git diff --quiet; then
    echo "â„¹ï¸ No changes to commit"
else
    echo "ðŸ“ Committing GitOps changes"
    git add .
    git commit -m "GitOps: Update ${ENVIRONMENT} to ${IMAGE_TAG}

- Environment: ${ENVIRONMENT}
- Image Tag: ${IMAGE_TAG}
- Image Digest: ${IMAGE_DIGEST}
- Source Commit: ${SOURCE_COMMIT}
- Updated by: CI Pipeline"

    echo "âœ… GitOps update completed"
    echo "ðŸ”„ ArgoCD will detect and sync changes"
fi

echo ""
echo "ðŸ“Š GitOps Update Summary:"
echo "========================"
echo "âœ… Environment: ${ENVIRONMENT}"
echo "âœ… Image Tag: ${IMAGE_TAG}"
echo "ðŸ“ Updated Path: ${K8S_PATH}"
echo "ðŸ”„ Next: ArgoCD sync (automatic for dev, manual for staging/prod)"
